pipeline {
  agent any

  environment {
    PYTHON_EXE = '"C:\\Program Files\\Python311\\python.exe"'
    VIRTUAL_ENV = 'venv'
  }

  stages {

    stage('Setup') {
      steps {
        bat '''
          %PYTHON_EXE% -m venv %VIRTUAL_ENV%
          call %VIRTUAL_ENV%\\Scripts\\activate
          %PYTHON_EXE% -m pip install --upgrade pip
          pip install -r requirements.txt
        '''
      }
    }

    stage('Lint') {
      steps {
        bat '''
          call %VIRTUAL_ENV%\\Scripts\\activate
          flake8 app.py
        '''
      }
    }

    stage('Test') {
      steps {
        bat '''
          call %VIRTUAL_ENV%\\Scripts\\activate
          set PYTHONPATH=%CD%
          pytest
        '''
      }
    }

    stage('Coverage') {
      steps {
        bat '''
          call %VIRTUAL_ENV%\\Scripts\\activate
          set PYTHONPATH=%CD%
          coverage run -m pytest
          coverage report
          coverage html
        '''
      }
      post {
        always {
          archiveArtifacts artifacts: 'htmlcov/**', allowEmptyArchive: true
        }
      }
    }

    stage('Security Scan') {
      steps {
        bat '''
          call %VIRTUAL_ENV%\\Scripts\\activate
          bandit -r . -f json -o bandit-report.json || exit 0
          bandit -r .
        '''
      }
      post {
        always {
          archiveArtifacts artifacts: 'bandit-report.json', allowEmptyArchive: true
        }
      }
    }

    stage('Deploy') {
      steps {
        bat '''
          call %VIRTUAL_ENV%\\Scripts\\activate
          echo "Deploying application..."
          echo "Creating deployment package..."
          if not exist deploy mkdir deploy
          copy app.py deploy\\
          copy requirements.txt deploy\\
          echo "Deployment package created successfully!"
          echo "Ready for deployment to remote server."
        '''
      }
    }
  }

  post {
    always {
      cleanWs()
    }
  }
}

